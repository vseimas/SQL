
-- Creating the temp table
select 
a.pidm_key, a.term_code_key, a.COLL_CODE, a.DISCIPLINE, a.majr_desc1, a.uopi_status, cast(b.IRSV as INT) as RW_SAT, cast(b.IRSM as INT) as Math_SAT, cast(b.IRSM as decimal)+cast(b.IRSV as decimal) SATT, b.TEST_SCORE6 act_composite
into #temp
from ENR a WITH (NOLOCK) 
left join ADM b on a.pidm_key = b.pidm_key and a.term_code_key = b.term_code_key
where report = '1'
and a.styp_code = 'n'
and (a.term_code_key >= '201381')
and a.term_desc like ('%fall%')
and (a.UOPI_status in ('not UOPI','integrated accelerator') or a.UOPI_Status is null)

--Account for students who only have one part of the SAT score (ex. has a SAT math score but no SAT eng score)
update #temp set RW_SAT = null where Math_SAT is null
update #temp set Math_SAT = null where RW_SAT is null; -- remove the ; to run as is - leave it to get the average numbers


-- calculating percentiles off all students with SAT values
 WITH PERC AS (
select TERM_CODE_KEY,
PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY RW_SAT) OVER (PARTITION BY TERM_CODE_KEY) AS PERC25_RW,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY RW_SAT) OVER (PARTITION BY TERM_CODE_KEY) AS PERC50_RW,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY RW_SAT) OVER (PARTITION BY TERM_CODE_KEY)  AS PERC75_RW,
PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY Math_SAT) OVER (PARTITION BY TERM_CODE_KEY) AS PERC25_Math,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY Math_SAT) OVER (PARTITION BY TERM_CODE_KEY) AS PERC50_Math,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY Math_SAT) OVER (PARTITION BY TERM_CODE_KEY)  AS PERC75_Math
from #temp
where TERM_CODE_KEY = '202381'
and SATT is not NULL

)

SELECT TERM_CODE_KEY, PERC25_RW, PERC50_RW, PERC75_RW, PERC25_Math, PERC50_Math, PERC75_Math, count(*) AS Count
FROM PERC
group by TERM_CODE_KEY, PERC25_RW, PERC50_RW, PERC75_RW, PERC25_Math, PERC50_Math, PERC75_Math


drop table #temp
